<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Mapa Interativo - Quadras</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <style>
        body, html { height: 100%; margin: 0; font-family: Arial, sans-serif; }
        nav { padding: 10px; background:#0d6efd; color:#fff; }
        main { padding: 10px; }
        #map { width: 100%; height: 72vh; border: 1px solid #ddd; border-radius:6px; }
        .search-bar {
            display:flex;
            gap:8px;
            margin-bottom:10px;
            align-items:center;
        }
        .search-bar input[type="search"] {
            flex:1;
            padding:8px 10px;
            border-radius:4px;
            border:1px solid #ccc;
            box-sizing: border-box;
        }
        .search-bar button {
            padding:8px 12px;
            border-radius:4px;
            background:#0d6efd;
            color:#fff;
            border:none;
            cursor:pointer;
        }
        .results {
            margin-top:8px;
            max-height:200px;
            overflow:auto;
            font-size:0.9rem;
        }
        .result-item { padding:6px; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; align-items:center; gap:8px; }
        .result-item:hover { background:#f7f7f7; }
        .result-left { flex: 1; }
        .result-actions a { text-decoration: none; color: #0d6efd; font-size:0.9rem; }
        .info { color:#666; margin-top:6px; font-size:0.9rem; }

        /* classes para indicar acesso */
        .access-open { color: #127a13; font-weight:600; }        /* Público */
        .access-closed { color: #b02a37; font-weight:600; }      /* Privado/Restrito */
        .access-unknown { color: #6c757d; font-weight:600; }     /* Desconhecido / verificar */
    </style>
</head>
<body>
    <nav>ConectaEsporte — Mapa de Quadras</nav>
    <main>
        <h1>Procure quadras públicas</h1>

        <div class="search-bar" role="search" aria-label="Busca de quadras">
            <input id="query" type="search" placeholder="Ex.: quadras de tênis, futsal perto de mim, quadras públicas" />
            <button id="searchBtn">Pesquisar</button>
            <button id="clearBtn" title="Limpar resultados" style="background:#6c757d">Limpar</button>
        </div>
        <div class="info">Dica: posicione o mapa na área desejada antes de pesquisar — a busca usa os limites visíveis.</div>
        <div id="map" aria-label="Mapa do Brasil interativo"></div>
        <div class="results" id="results"></div>
    </main>
    <footer>Busca via Overpass API (OpenStreetMap). Resultados públicos.</footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const brasilCenter = [-14.2350, -51.9253];
        const map = L.map('map', { zoomControl: true }).setView(brasilCenter, 4);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        L.control.scale().addTo(map);

        const markerLayer = L.layerGroup().addTo(map);

        const queryEl = document.getElementById('query');
        const searchBtn = document.getElementById('searchBtn');
        const clearBtn = document.getElementById('clearBtn');
        const resultsEl = document.getElementById('results');

        function parseQueryToFilters(q) {
            const text = (q || '').toLowerCase();
            const filters = [];

            const sportMap = [
                { keys: ['tênis', 'tenis'], value: 'tennis' },
                { keys: ['basquete', 'basquetebol', 'basket'], value: 'basketball' },
                { keys: ['futebol', 'futsal', 'soccer', 'football'], value: 'football' },
                { keys: ['voleibol', 'volei'], value: 'volleyball' }
            ];

            let detectedSport = null;
            for (const m of sportMap) {
                if (m.keys.some(k => text.includes(k))) { detectedSport = m.value; break; }
            }

            if (detectedSport) {
                filters.push(`["leisure"="pitch"]["sport"="${detectedSport}"]`);
                filters.push(`["amenity"="sports_centre"]["sport"="${detectedSport}"]`);
                filters.push(`["sport"="${detectedSport}"]`);
            } else {
                filters.push(`["leisure"="pitch"]`);
                filters.push(`["amenity"="sports_centre"]`);
            }

            return filters;
        }

        function buildOverpassQL(filters, bbox) {
            let blocks = '';
            filters.forEach(f => {
                blocks += `node${f}(${bbox});\n`;
                blocks += `way${f}(${bbox});\n`;
                blocks += `relation${f}(${bbox});\n`;
            });

            return `[out:json][timeout:25];
(
${blocks}
);
out center;`;
        }

        function humanizeSport(s) {
            if (!s) return '';
            const k = s.toLowerCase();
            const map = { 'tennis': 'Tênis', 'football': 'Futebol', 'futsal': 'Futsal', 'basketball': 'Basquete', 'volleyball': 'Voleibol', 'soccer': 'Futebol' };
            return map[k] || s.charAt(0).toUpperCase() + s.slice(1);
        }

        function humanizeLeisure(l) {
            if (!l) return '';
            const k = l.toLowerCase();
            const map = { 'pitch': 'Quadra / Campo', 'sports_centre': 'Centro Esportivo', 'stadium': 'Estádio' };
            return map[k] || l;
        }

        function ensureUrlProtocol(u) {
            if (!u) return null;
            if (/^https?:\/\//i.test(u)) return u;
            return 'https://' + u;
        }

        function buildInfoUrl(tags, el) {
            if (!tags) tags = {};
            const site = tags.website || tags.url || tags['contact:website'];
            if (site) return ensureUrlProtocol(site);

            if (tags.wikipedia) {
                const parts = tags.wikipedia.split(':');
                if (parts.length >= 2) {
                    const lang = parts.shift();
                    const page = parts.join(':');
                    return `https://${lang}.wikipedia.org/wiki/${encodeURIComponent(page)}`;
                } else {
                    return `https://pt.wikipedia.org/wiki/${encodeURIComponent(tags.wikipedia)}`;
                }
            }

            if (el && el.type && el.id) {
                return `https://www.openstreetmap.org/${el.type}/${el.id}`;
            }

            return null;
        }

        // retorna dono/operador se disponível
        function getOwnerLabel(tags) {
            if (!tags) return null;
            const keys = ['operator', 'owner', 'operator:owner', 'contact:owner', 'contact:website', 'owner:official'];
            for (const k of keys) {
                if (tags[k]) {
                    return String(tags[k]).trim();
                }
            }
            return null;
        }

        // função que determina se o local é público ou privado (heurísticas)
        function determineAccess(tags) {
            if (!tags) return { label: 'Desconhecido', css: 'access-unknown' };

            // 1) checa tag access explícita
            const access = (tags.access || tags['access:conditional'] || '').toLowerCase();
            if (access.includes('yes') || access.includes('public') || access.includes('open')) {
                return { label: 'Público', css: 'access-open' };
            }
            if (access.includes('no') || access.includes('private') || access.includes('restricted')) {
                return { label: 'Privado/Restrito', css: 'access-closed' };
            }

            // 2) cobrança indicativa -> trata como não totalmente aberto
            const fee = (tags.fee || tags['fee'] || tags.charge || '').toLowerCase();
            if (fee && (fee.includes('yes') || fee.includes('paid') || fee.includes('ticket'))) {
                return { label: 'Privado / Pago', css: 'access-closed' };
            }

            // 3) usos escolares normalmente restritos
            const landuse = (tags.landuse || '').toLowerCase();
            if (['school', 'college', 'university', 'education'].includes(landuse)) {
                return { label: 'Restrito (uso escolar)', css: 'access-closed' };
            }

            // 4) operador com indicação pública -> consideramos público
            const operator = (tags.operator || '').toLowerCase();
            const publicKeywords = ['prefeitura', 'municipal', 'município', 'cidade', 'secretaria', 'governo', 'city', 'municipalidad', 'department', 'pref'];
            if (publicKeywords.some(k => operator.includes(k))) {
                return { label: 'Público', css: 'access-open' };
            }

            // 5) proprietário com indicativo "privado"
            const owner = (tags.owner || tags['operator:owner'] || '').toLowerCase();
            if (owner.includes('priv') || owner.includes('particular') || owner.includes('private')) {
                return { label: 'Privado', css: 'access-closed' };
            }

            // 6) amenidades tipicamente públicas
            const amen = (tags.amenity || '').toLowerCase();
            const leisure = (tags.leisure || '').toLowerCase();
            if (amen === 'park' || leisure === 'park' || amen === 'playground' || leisure === 'playground') {
                return { label: 'Público', css: 'access-open' };
            }

            // 7) se tiver website/telefone/operador, tende a ser acessível (heurística)
            if (tags.website || tags.phone || tags['contact:website']) {
                return { label: 'Público (verificar)', css: 'access-open' };
            }

            // fallback
            return { label: 'Desconhecido', css: 'access-unknown' };
        }

        async function searchQuadras(queryText) {
            markerLayer.clearLayers();
            resultsEl.innerHTML = 'Buscando...';

            const bounds = map.getBounds();
            const s = bounds.getSouth();
            const w = bounds.getWest();
            const n = bounds.getNorth();
            const e = bounds.getEast();
            const bbox = `${s},${w},${n},${e}`;

            const filters = parseQueryToFilters(queryText);
            const q = buildOverpassQL(filters, bbox);

            try {
                const res = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: q,
                    headers: { 'Content-Type': 'text/plain' }
                });

                if (!res.ok) throw new Error('Overpass retornou ' + res.status);

                const data = await res.json();
                console.log('Overpass data:', data);
                const elements = data.elements || [];
                if (elements.length === 0) {
                    resultsEl.innerHTML = '<div class="result-item">Nenhuma quadra encontrada na área visível.</div>';
                    return;
                }

                resultsEl.innerHTML = '';
                elements.forEach((el) => {
                    let lat, lon;
                    if (el.type === 'node') { lat = el.lat; lon = el.lon; }
                    else if ((el.type === 'way' || el.type === 'relation') && el.center) { lat = el.center.lat; lon = el.center.lon; }
                    if (lat == null || lon == null) return;

                    const tags = el.tags || {};

                    const preferredName = tags['name:pt'] || tags.name || tags.ref || (tags['addr:street'] ? (tags['addr:street'] + (tags['addr:housenumber'] ? ' ' + tags['addr:housenumber'] : '')) : null);

                    let title;
                    if (preferredName) title = preferredName;
                    else if (tags.sport) title = humanizeSport(tags.sport) + (tags.leisure ? ' — ' + humanizeLeisure(tags.leisure) : '');
                    else if (tags.leisure) title = humanizeLeisure(tags.leisure);
                    else title = 'Quadra pública';

                    const popupParts = [];
                    popupParts.push(`<strong>${escapeHtml(title)}</strong>`);
                    if (tags.sport) popupParts.push('Esporte: ' + escapeHtml(humanizeSport(tags.sport)));
                    if (tags.leisure) popupParts.push('Tipo: ' + escapeHtml(humanizeLeisure(tags.leisure)));
                    if (tags.operator) popupParts.push('Operador: ' + escapeHtml(tags.operator));
                    if (tags['addr:street']) popupParts.push('Endereço: ' + escapeHtml(tags['addr:street'] + (tags['addr:housenumber'] ? ', ' + tags['addr:housenumber'] : '')));
                    if (tags.phone) popupParts.push('Telefone: ' + escapeHtml(tags.phone));
                    if (tags.opening_hours) popupParts.push('Horário: ' + escapeHtml(tags.opening_hours));

                    // preferir mostrar o dono/operador quando existir, senão mostrar acesso
                    const ownerLabel = getOwnerLabel(tags);
                    if (ownerLabel) {
                        popupParts.push('Dono/Operador: ' + escapeHtml(ownerLabel));
                    } else {
                        const accessInfo = determineAccess(tags);
                        popupParts.push(`<span class="${accessInfo.css}">Acesso: ${escapeHtml(accessInfo.label)}</span>`);
                    }

                    const infoUrl = buildInfoUrl(tags, el);
                    if (infoUrl) {
                        popupParts.push(`<a href="${escapeHtml(infoUrl)}" target="_blank" rel="noopener noreferrer">Mais informações</a>`);
                    } else {
                        popupParts.push('<small>Fonte: OpenStreetMap</small>');
                    }

                    const marker = L.marker([lat, lon]).addTo(markerLayer);
                    marker.bindPopup(popupParts.join('<br>'));

                    const item = document.createElement('div');
                    item.className = 'result-item';
                    const left = document.createElement('div');
                    left.className = 'result-left';
                    const street = tags['addr:street'] ? escapeHtml(tags['addr:street']) : '';
                    const sportLabel = tags.sport ? escapeHtml(humanizeSport(tags.sport)) : '';

                    // na lista: mostra dono se houver, senão o status de acesso
                    const ownerOrAccessHtml = ownerLabel
                        ? `<br><small>Dono/Operador: ${escapeHtml(ownerLabel)}</small>`
                        : (() => {
                            const ai = determineAccess(tags);
                            return `<br><small class="${ai.css}">${escapeHtml(ai.label)}</small>`;
                        })();

                    left.innerHTML = `<strong>${escapeHtml(title)}</strong>${sportLabel ? ' — ' + sportLabel : ''}<br><small>${street}</small>${ownerOrAccessHtml}`;

                    const actions = document.createElement('div');
                    actions.className = 'result-actions';
                    if (infoUrl) {
                        const a = document.createElement('a');
                        a.href = infoUrl;
                        a.target = '_blank';
                        a.rel = 'noopener noreferrer';
                        a.textContent = 'Mais info';
                        actions.appendChild(a);
                    } else {
                        const a = document.createElement('a');
                        a.href = `https://www.openstreetmap.org/${el.type}/${el.id}`;
                        a.target = '_blank';
                        a.rel = 'noopener noreferrer';
                        a.textContent = 'Ver OSM';
                        actions.appendChild(a);
                    }

                    item.appendChild(left);
                    item.appendChild(actions);

                    item.addEventListener('click', function (evt) {
                        if (evt.target.tagName.toLowerCase() === 'a') return;
                        map.setView([lat, lon], 17);
                        marker.openPopup();
                    });
                    resultsEl.appendChild(item);
                });

            } catch (err) {
                resultsEl.innerHTML = `<div class="result-item">Erro na busca: ${escapeHtml(err.message || String(err))}</div>`;
            }
        }

        function escapeHtml(s) {
            if (s == null) return '';
            return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
        }

        searchBtn.addEventListener('click', function () {
            searchQuadras(queryEl.value);
        });

        queryEl.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchQuadras(queryEl.value);
            }
        });

        clearBtn.addEventListener('click', function () {
            markerLayer.clearLayers();
            resultsEl.innerHTML = '';
            queryEl.value = '';
        });

        map.on('click', function (e) {
            L.popup()
                .setLatLng(e.latlng)
                .setContent(`Coordenadas: ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`)
                .openOn(map);
        });
    });
    </script>
</body>
</html>